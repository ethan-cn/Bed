{% extends "base.html" %}
<html lang="en">
<head>

</head>
<body class="app sidebar-mini">
{% block content %}
<main class="app-content">
    <div class="app-title">
        <div>
            <h1><i class="fa fa-file-code-o"></i> 入院管理</h1>
            <p>患者详细信息</p>
        </div>
        <ul class="app-breadcrumb breadcrumb">
            <li class="breadcrumb-item"><i class="fa fa-home fa-lg"></i></li>
            <li class="breadcrumb-item"><a href="#">入院管理</a></li>
        </ul>
    </div>
    <div class="tile">
        <div class="tile-body">
            <div class="container-fluid main-content">
                <div class="widget-container fluid-height clearfix">
                    <div class="heading clearfix">
                        <i class="icon-table"></i>

                        <a id="new_user" class="btn btn-sm btn-primary pull-right"
                           href="/redirect_new_patient/"><i
                                class="icon-plus fa fa-plus"></i> 入院登记</a>

                    </div>
                    <div class="widget-content padded clearfix">
                        <div class="dataTables_filter">
                            <form class="form-inline">
                                <div class="btn-group">
                                    <span>患者姓名：</span> <input type="text" class="form-control"
                                                             id="emmployeeId" name="emmployeeId" value="">
                                </div>
                                <div class="btn-group">
                                    <input type="button" class="btn btn-success" value="搜索"
                                           onclick="show_user_info()"/>
                                </div>
                            </form>
                        </div>
                        <div id="w0" class="grid-view">
                            <div class="table-responsive">
                                <table class="table table-hover" id="user_info">
                                    <thead>
                                    <tr align="center">
                                        <!--                                            <th nowrap>ID</th>-->
                                        <th nowrap>姓名</th>
                                        <th nowrap>性别</th>
                                        <th nowrap>年龄</th>
                                        <th nowrap>科室</th>
                                        <th nowrap>床位</th>
                                        <th nowrap>病情描述</th>
                                        <th nowrap>入院时间</th>
                                        <th nowrap>更新时间</th>
                                        <th class="action-column" id="operate">操作</th>
                                    </tr>
                                    </thead>
                                    <tbody align="center">
                                    </tbody>
                                </table>
                                <div id="pages"><span id="spanFirst">首页</span> <span id="spanPre">上一页</span> <span
                                        id="spanNext">下一页</span> <span id="spanLast">尾页</span> 第<strong
                                        id="spanPageNum"></strong>页/共<strong id="spanTotalPage"></strong>页
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <form class="form-horizontal" role="form" id="form_data" style="margin: 20px;">
        <div class="modal fade" id="modifyUserInfo" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
             aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">

                        <h4 class="modal-title" id="myModalLabel">更换床位</h4>
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    </div>
                    <div class="modal-body">
                        <form class="form-horizontal" role="form">
                            <div class="form-inline form-group">
                                <label for="name" class="col-sm-4">姓名: </label>
                                <input type="hidden" id="userId" name="userId" type="text"/>
                                <input id="name" class='form-control col-sm-5' name="name" type="text" title="姓名"
                                       placeholder="请输入姓名" required="required"/>
                            </div>
                            <div class="form-inline form-group">
                                <label for="bed_name" class="col-sm-4">床位名称: </label>
                                <input id="bed_name" class='form-control col-sm-5' name="bed_name" type="text"
                                       title="姓名"
                                       placeholder="" disabled="disabled"/>
                            </div>
                            <div class="form-inline form-group">
                                <label for="price" class="col-sm-4">床位价格: </label>
                                <select id="price" class='form-control col-sm-5' name="price">
                                    <option>100元</option>
                                   <option>200元</option>
                                   <option>300元</option>
                                  <option>400元</option>
                                   <option>500元</option>
                                   <option>600元</option>
                                   <option>700元</option>
                                   <option>800元</option>
                                   <option>900元</option>
                                   <option>1000元</option>
                                </select>
                            </div>
                        </form>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">关闭
                        </button>
                        <input type="button" class="btn btn-primary" id="update" value="提交"/>


                        <span id="tip"> </span>
                    </div>
                </div><!-- /.modal-content -->
            </div><!-- /.modal -->

        </div>
    </form>
</main>
{% endblock %}

{% block script %}
<script type=text/javascript>
    var user_position = "";

    function modeify_patient_info(userId) {
        $.ajax({
                type: "get",
                url: "/get_patient_by_id/",
                data: {'id': userId},
                dataType: 'json',
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    var user_info = data['patient'];
                    console.log(user_info)
                    var name = user_info.name;
                    $("#name").val(name);
                    $("#userId").val(user_info.id);
                    $('#bed_name').val(user_info.bed_name)
                }
            }
        )
    }

    var result = true;

    $('#update').on('click', function () {
        var user_id = $('#userId').val();
        console.log($('#price').val())
        console.log($('#bed_name').val())
        $.ajax({
            type: "POST",
            url: "/modify_patient/",
            dataType: 'json',
            contentType: "application/json; charset=utf-8",
            data: {'id': user_id,'price':$('#price').val(),'bed_name':$('#bed_name').val()},
            success: function (data) {
                swal(data['message'])
                window.location.href = '/redirect_patient/'
            },

        })

    })

    //获取第一页用户信息
    var total_page;

    function get_user_data(current_page) {
        $.ajax({
            type: "get",
            url: "/query_patient/",
            async: false,
            dataType: 'json',
            data: {'page': current_page},
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                console.log(data)
                user_info = data.patient;
                total_page = data.total;
            }
        });
        return user_info
    }

    var current_page = 1;
    var totalPage = document.getElementById("spanTotalPage");
    var pageNum = document.getElementById("spanPageNum"); //获取当前页<span>
    var spanPre = document.getElementById("spanPre"); //获取上一页<span>
    var spanNext = document.getElementById("spanNext"); //获取下一页<span>
    var spanFirst = document.getElementById("spanFirst"); //获取第一页<span>
    var spanLast = document.getElementById("spanLast"); //获取最后一页<span>

    var info = get_user_data(current_page);

    function show_table() {
        //获取第一页用户信息
        var table_value = '<tr "data-key" ="1">';
        for (var i = 0; i < info.length; i++) {
            var patient_id = info[i].id;
            table_value += "<td>";
            // table_value += patient_id + "</td><td>";
            table_value += info[i].name + "</td><td>";
            table_value += info[i].gender + "</td><td>";
            table_value += info[i].age + "</td><td>";
            table_value += info[i].department + "</td><td>";
            table_value += info[i].bedroom + "</td><td>";
            table_value += info[i].description + "</td><td>";
            table_value += info[i].created + "</td><td>";
            table_value += info[i].modified + "</td><td>";
            if (info[i].bedroom == '已出院') {
                table_value += "<a class='btn btn-info' data-toggle='modal' id =" + patient_id + " data-target='#modifyUserInfo'  disabled='disabled'>" + "无法操作" + "</a>";

            } else {
                table_value += "<a class='btn btn-success' data-toggle='modal' id =" + patient_id + " data-target='#modifyUserInfo' onclick='modeify_patient_info(this.id)'>" + "换床" + "</a>";
                table_value += "<button class='btn btn-danger' id=" + "'" + patient_id + "'" + "name='delete' onclick='delete_user_info(this.id)'>停床</button></td>";
            }
            table_value += "</tr>";
        }
        $("tbody").html(table_value);

        if ((current_page == total_page) & (total_page != 1)) {
            preLink();
            nextText();
            firstLink();
            lastText();
            showCurrentPage();
            showTotalPage();
        } else if ((current_page == total_page) & (total_page == 1)) {
            preText();
            nextText();
            lastText();
            firstText();
            showCurrentPage();
            showTotalPage();
        } else if (current_page == 1) {
            preText();
            nextLink();
            firstText();
            lastLink();
            showCurrentPage();
            showTotalPage();
        } else {
            preLink();
            firstLink();
            nextLink();
            lastLink();
            showCurrentPage();
            showTotalPage();
        }
    }

    show_table();

    function showTotalPage() {
        totalPage.innerHTML = total_page;
    }

    function showCurrentPage() {
        pageNum.innerHTML = current_page;
    }

    //上一页链接
    function preLink() {
        spanPre.innerHTML = "<a href='javascript:pre();'>上一页</a>";
    }

    function preText() {
        spanPre.innerHTML = "上一页";
    }

    //下一页链接
    function nextLink() {
        spanNext.innerHTML = "<a href='javascript:next_page();'>下一页</a>";
    }

    function nextText() {
        spanNext.innerHTML = "下一页";
    }

    //首页链接
    function firstLink() {
        spanFirst.innerHTML = "<a href='javascript:first_page();'>首页</a>";
    }

    function firstText() {
        spanFirst.innerHTML = "首页";
    }

    //尾页链接
    function lastLink() {
        spanLast.innerHTML = "<a href='javascript:last_page();'>末页</a>";
    }

    function lastText() {
        spanLast.innerHTML = "末页";
    }

    //上一页
    function pre() {
        current_page -= 1;
        info = get_user_data(current_page);
        show_table()

    }

    //首页
    function first_page() {
        current_page = 1;
        info = get_user_data(current_page);
        show_table()
    }

    //下一页
    function next_page() {
        current_page += 1;
        info = get_user_data(current_page);
        show_table()
    }

    //尾页
    function last_page() {
        current_page = total_page;
        info = get_user_data(current_page);
        show_table()
    }


    //删除用户
    function delete_user_info(patient_id) {
        swal({
            title: "确定停床么?",
            text: "你将无法恢复这个操作！",
            type: "warning",
            showCancelButton: true,
            confirmButtonText: "确定",
            cancelButtonText: "取消",
            closeOnConfirm: false,
            closeOnCancel: false
        }, function (isConfirm) {
            if (isConfirm) {
                $.ajax({
                    type: "POST",
                    dataType: "json",
                    url: "/delete_patient/",
                    data: {'patient_id': patient_id},
                    success: function (data) {
                        window.location.href = '/redirect_patient/';
                        swal("已停床!", "停床成功", "success");
                    },
                    error: function (xhr) {
                        swal("停床失败!", "停床失败", "error");
                    }
                });

            } else {
                swal("已取消", "删除操作已取消 :)", "error");
            }
        });

    }

    //通过用户名模糊查询用户
    function show_user_info() {
        current_page = 1;
        let user_name = $('#emmployeeId').val();
        if (user_name) {
            function get_user_info() {
                $.ajax({
                    type: "get",
                    url: "/get_patient_by_name/",
                    dataType: "json",
                    data: {'page': current_page, 'name': user_name},
                    contentType: "application/json; charset=utf-8",
                    async: false,
                    success: function (data) {
                        console.log(data);
                        uinfo = data.patient;
                        total_page = data.total;
                    },
                    error: function () {
                        var table = document.getElementsByTagName("table")[0];
                        var table_rows = table.rows;
                        for (var i = 1; i < table_rows.length; i++) {
                            table_rows[i].style.display = 'none';
                        }
                        spanPre.innerHTML = "上一页";
                        spanFirst.innerHTML = "首页";
                        spanNext.innerHTML = "下一页";
                        spanLast.innerHTML = "末页";
                        pageNum.innerHTML = 0;
                        totalPage.innerHTML = 0;
                    }

                });
                return uinfo;
            }
        } else {
            window.location.href = '/redirect_patient'
        }

        if (user_name == "") {
            show_table()

        } else {
            info = get_user_info();
            show_table()
        }
    }


</script>
{% endblock %}
</body>
</html>